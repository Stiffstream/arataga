# Что такое arataga?

arataga -- это работающий прототип socks5 + http/1.1 прокси сервера. arataga разрабатывался компанией [stiffstream](https://stiffstream.com) для заказчика, который затем отказался от этого проекта. Дабы не выбрасывать получившийся результат, исходный код arataga был открыт под лицензией GNU Affero GPL v3.

arataga создавался под следующие условия:

* требовалось открывать от 5 до 10 тысяч точек входа на одном прокси-сервере. Каждая точка входа (т.н. ACL) -- это уникальное сочетание IPv4 адреса и TCP/IP порта;
* требовалось предоставлять доступ к прокси-серверу для нескольких десятков тысяч пользователей;
* требовалось обслуживать несколько десятков тысяч (от 40 тысяч и более) одновременных подключений;
* требовалось работать в условиях частого подключения/отключения клиентов (с темпом в 1000 новых подключений в секунду и выше);
* требовалось ограничивать пропускную способность для подключений клиентов (например, все подключения клиента на один ACL не могут суммарно потреблять больше 10MiB/s);
* требовалось ограничивать пропускную способность для клиентов с учетом целевого домена (например, для клиента лимит в 10MiB/s, но при обращении к instagram.com этот лимит снижается до 5MiB/s);
* конфигурацию и списки пользователей, которым разрешена работа с arataga, нужно получать на специальную HTTP-точку входа. Копии текущей конфигурации и списка пользователей должны храниться локально и использоваться при рестартах.

На данный момент arataga находится в состоянии работающего прототипа. Это означает, что практически весь его функционал работает и был протестирован внутри stiffstream в рамках имевшихся у нас ресурсов. Из изначально запланированных возможностей не была реализована только асинхронная работа с DNS-серверами, перечень которых должен был задаваться в конфигурационном файле.

Серьезного тестирования в приближенных к "боевым" условиям не проводилось, т.к. внутри stiffstream не было ресурсов для создания соответствующего тестового стенда, на котором можно было открыть достаточное количество IP-адресов и создать тестовый трафик на 60-80 тысячах одновременных подключений, а заказчик, который располагал необходимыми ресурсами потерял интерес к проекту без объяснения причин.

# Зачем исходники arataga были открыты?

Есть две основные причины открытия исходников arataga.

Первая причина: arataga является отличным проектом для демонстрации того, как выглядит реальный код на базе [SObjectizer](https://github.com/Stiffstream/sobjectizer) и [RESTinio](https://github.com/Stiffstream/restinio).

Если кто-то слышал о SObjectizer и/или RESTinio и хочет посмотреть на любую из этих библиотек в реальном проекте, то arataga отлично подходит для этой цели. arataga разрабатывался с прицелом на применение в продакшене, это не простенький HelloWorld на 100 строк.

Так что если вы хотите составить себе представление о том, как может выглядеть код с использованием SObjectizer и/или RESTinio, то можете заглянуть в исходники arataga.

Вторая причина: жалко выбрасывать продукт, в который был вложен наш труд. Может быть кому-то результаты нашей работы пригодятся.

Так что если вас заинтересовали возможности arataga, но чего-то вам не хватает, то вы можете [связаться с нами](mailto:info@stiffstream.com) и обсудить доработку arataga под ваши условия, цели и задачи. В том числе и в виде закрытого форка.

Ну и можно отметить еще и третью причину, хотя она и не основная: мы сами рассматриваем arataga как отличный полигон для проверки новых версий SObjectizer и RESTinio в условиях, близких к боевым.

# Как взять и попробовать?

Компилятор с более-менее нормальной поддержкой C++17 (filesystem должен быть доступен "из коробки"), например, GCC-8 или более новый.

Операционная система GNU/Linux. У нас не было требований поддерживать другие ОС. Мы проверяли на Ubuntu 18.04 и 20.04.

## Как взять?

В данном репозитории находятся только исходные тексты самих примеров. Исходные тексты зависимостей (т.к. asio, fmtlib, sobjectizer, doctest, restinio и пр.) в репозиторий не включены. Есть два способа взять примеры с необходимыми для них зависимостями.

### Загрузить полный архив

В секции Releases находятся архивы, в которые включены все исходные тексты: и arataga, и всех зависимостей. Поэтому самый простой способ -- это загрузить соответствующий архив из Releases, распаковать его, зайти в arataga и перейти к компиляции примеров.

### Использовать MxxRu::externals

В этом случае вам потребуется Ruby + MxxRu + различный инструментарий, который из коробки есть у Linux-разработчиков (вроде git, tar, unzip и пр.). В этом случае:

* Устанавливаем Ruby и RubyGems (обычно RubyGems идет сразу с Ruby, но где-то может придется ставить отдельно).
* Устанавливаем MxxRu: `gem install Mxx_ru`
* Делаем git clone: `git clone https://github.com/Stiffstream/arataga`
* Заходим в нужный подкаталог: `cd arataga`
* Запускаем команду `mxxruexternals`.
* Ждем пока все зависимости подтянутся.

После этого можно переходить к компиляции.

## Как попробовать?

### Компиляция посредством MxxRu

На данный момент поддерживается только сборка посредством MxxRu. Поэтому перед сборкой вам нужно будет установить Ruby и RubyGems (обычно RubyGems идет сразу с Ruby, но где-то может придется ставить отдельно), после чего выполнить установку MxxRu: `gem install Mxx_ru`.

Для компиляции заходим в каталог arataga и выполняем команду `ruby build.rb`. Результат сборки будет находиться в `target/release/bin`.

Если есть желание прогнать юнит-тесты, то следует выполнить команду `ruby build_tests.rb`.

### Подготовка к запуску

#### Каталог для хранения локальных копий конфигурации

arataga потребуется каталог для хранения локальных копий конфигурации и списка пользователей. Этот каталог должен быть доступен для arataga для чтения и записи.

Проще всего создать этот каталог прямо внутри каталога arataga, например:

```
cd arataga
mkdir locals
```

#### Начальный файл с конфигурацией

Потребуется начальный файл с конфигурацией, в котором будут описаны основные параметры работы arataga и список точек доступа. Например, файл вида:

```
log_level info

bandlim.in 50MiBps
bandlim.out 50MiBps

acl.max.conn 500
acl.io.chunk_size 4kib

acl auto, port=3000, in_ip=127.0.0.1, out_ip=192.168.1.1
acl auto, port=3001, in_ip=192.168.1.1, out_ip=192.168.1.1
```

#### Начальный файл со списком пользователей

Потребуется начальный файл со списком пользователей, в котором будут перечислены пользователи. Например, файл вида:

```
127.0.0.1 3000 user 12345 = 0 0 0 1
192.168.1.1 3001 192.168.1.1 = 10MiBps 5MiBps 0 2
```

### Запуск и управление через HTTP-вход

Запустить arataga в консоли можно следующей командой:

```
./target/release/bin/arataga --no-daemonize \
  --admin-http-ip=127.0.0.1 --admin-http-port=8088 \
  --admin-http-token=54321 \
  --local-config-path=locals \
  --log-target=stdout \
  --log-level=debug
```

После этого остановить arataga можно будет посредством Ctrl+C.

После того, как arataga будет запущен, ему нужно будет передать конфигурацию и список пользователей посредством следующих команд:

```
curl \
  -H "arataga-admin-token: 54321" \
  -H "Content-Type: text/plain" \
  -X POST \
  --data-binary @my-config.cfg \
  http://localhost:8088/config

curl \
  -H "arataga-admin-token: 54321" \
  -H "Content-Type: text/plain" \
  -X POST \
  --data-binary @my-users.cfg \
  http://localhost:8088/users
```

После этого arataga создаст все необходимые точки входа и сможет принимать входящие подключения.

### Запуск и работа с локальной копией конфигов

После успешного приема конфигурации и списка пользователей arataga создает в каталоге, имя которого задано параметром командной строки `--local-config-path`, два файла: `local-config.cfg`, в котором содержится копия конфигурации, и `local-user-list.cfg`, в котором содержится копия списка пользователей. Эти локальные файлы используются arataga при рестартах -- если файлы есть, то при запуске arataga пытается их прочитать и, если это удалось, использует их содержимое.

Поэтому, если нет желания после запуска arataga выдавать управляющие команды через curl, то можно поступить проще: сразу создать файлы `local-config.cfg` и `local-user-list.cfg`. Например:

```
cp my-config.cfg locals/local-config.cfg
cp my-users.cfg locals/local-user-list.cfg
./target/release/bin/arataga --no-daemonize \
  --admin-http-ip=127.0.0.1 --admin-http-port=8088 \
  --admin-http-token=54321 \
  --local-config-path=locals \
  --log-target=stdout \
  --log-level=debug
```
# Административный HTTP-вход

arataga при старте создает HTTP-вход для получения новой конфигурации и обновленных списков пользователей. IP-адрес и TCP-порт этого HTTP-входа задается аргументами командной строки `--admin-http-ip` и `--admin-http-port`.

Все запросы, которые идут на административный HTTP-вход, должны содержать HTTP-поле (HTTP-заголовок) с именем `Arataga-Admin-Token` и тем же самым значением, которое было передано arataga в аргументе командной строки `--admin-http-token`. Запросы без такого HTTP-поля будут отклоняться.

## POST на /config

Для того, чтобы загрузить в arataga новую конфигурацию необходимо выполнить POST-запрос на `/config`. Тело запроса должно содержать конфигурацию в виде `text/plain`. Формат конфигурации описан в README_CONFIG.md.

## POST на /users

Для того, чтобы загрузить в arataga новый список пользователей необходимо выполнить POST-запрос на `/users`. Тело запроса должно содержать список пользователей в виде `text/plain`. Формат списка пользователей описан в README_USER_LIST.md.

## GET на /acls

GET-запрос на `/acls` позволяет получить в виде текста список существующий ACL внутри arataga.

## GET на /stats

GET-запрос на `/stats` позволяет получить в виде текста некоторые статистические данные о происходящем внутри arataga.

# Принцип работы

## Использование многопоточности

arataga представляет из себя многопоточное приложение, которое задействует возможности многоядерных процессоров для обработки большого количества точек входа и подключений к ним.

При старте arataga создает N рабочих потоков (нитей, threads), которые будут использоваться для обслуживания сетевых подключений. Значение N либо задается в командной строке параметром `--io-threads`, либо же вычисляется автоматически как (nCPU-2), где nCPU -- это количество доступных вычислительных ядер. Так, если запускать arataga на 8-ядерном процессоре без гипертрейдинга, то N будет равным 6 (при условии, что `--io-threads` не задан).

Все заданные в конфигурации ACL равномерно распределяются по этим N рабочим потокам. Т.е., если N=6, а в конфиге задано 3000 ACL, то на каждый рабочий поток будет приходится по 500 ACL.

Каждый ACL внутри arataga обслуживается отдельным объектом-агентом. Агент создается для очередного ACL при обработке конфигурации и привязывается к конкретной рабочей нити. После того, как агент-ACL оказался привязан к конкретной нити, он так и останется работать на этой нити до тех пор, пока arataga не завершит свою работу или же соответствующий ACL не будет изъят из конфигурации.

### Локализация операций разрешения доменных имен и аутентификации клиента

На каждой рабочей нити arataga запускает отдельные экземпляры двух специальных агентов: dns_resolver и authentificator. Т.е., если arataga стартовал на 6 рабочих потоках, то внутри arataga будет 6 агентов dns_resolver и 6 агентов authentificator.

Каждая пара dns_resolver+authentificator привязана к своей рабочей нити. При этом агенты-ACL, которые привязаны к этой же рабочей нити, общаются только с этой парой агентов dns_resolver+authenitificator. Таким образом практически весь обмен информации между сущностями, обслуживающими подключения клиентов (т.е. агенты-ACL, dns_resolver, authentificator), происходит только их общем рабочем контексте.

Агент dns_resolver отвечает за операции разрешения доменных имен (т.е. определяет IP адрес, соответствующий доменному имени).

Агент authentificator хранит списки пользователей и производит аутентификацию очередного подключившегося клиента.

## Изменение конфигурации в процессе работы

### Изменение списка ACL

В процессе работы arataga ему может быть передана новая конфигурация через HTTP-вход. В этом случае arataga подхватит новые параметры без необходимости перезапуска всего arataga.

При получении новой конфигурации arataga сравнивает свой текущий список ACL и новый список ACL. Все агенты-ACL, которые исчезли из нового списка, будут уничтожены. Для новых ACL, которые есть в новом списке, но не было в старом, будут созданы новые агенты-ACL.

Если у какой-то ACL изменился тип (например, изначально ACL обслуживала только HTTP-протокол, а затем ее изменили на socks5 протокол), то старый агент-ACL будет уничтожен, а на его место будет создан новый агент. Соответственно, при этом все подключения, которые обслуживались через этого агента, будут разорваны.

При обновлении конфигурации может сложиться ситуация, когда на какой-то из рабочих нитей будет уничтожено гораздо больше старых агентов-ACL, чем на других нитях. Возникнет диспропорция, при которой на одной нити, например, будет работать 100 агентов-ACL, а на остальных по 250 агентов.

В этом случае arataga не будет перераспределять оставшихся старых агентов-ACL между нитями для того, чтобы уравнять количество агентов-ACL. Поэтому, если при обновлении конфигурации будут только удаляться ACL, то подобные диспропорции будут возникать и будут сохраняться до рестарта arataga.

Если же кроме удаления старых ACL при переконфигурировании происходит и создании новых ACL, то arataga будет создавать новые агенты-ACL так, чтобы новые агенты привязывались к рабочим нитям с наименьшим количеством живых агентов-ACL.

### Изменение списка пользователей

В процессе работы arataga ему может быть передан новый список пользователей через HTTP-вход. Это позволяет обновлять списки пользователей без рестарта arataga.

Если в обновленном списке пользователя для какого-то из пользователей изменились разрешенные лимиты (например, лимит был уменьшен с 10MiB/s до 5MiB/s), то новые лимиты будут применяться сразу и для уже существующих, и для новых подключений данного клиента.

В текущей версии arataga при изменении списка пользователей соединения, которые были сделаны пользователями, которых нет в новом списке, в текущей версии arataga не обрываются принудительно. Это означает, что если пользователь создал долго живущее подключение к arataga, а затем этого пользователя из списка выбросили, то его соединение продолжит жить и будет обслуживаться arataga. 

# Дополнительная информация

Параметры командной строки описаны в файле README_CMDLINE.md.

Формат и параметры конфигурационного файла описаны в README_CONFIG.md.

Формат списка пользователей описан в README_USER_LIST.md.

Примеры взаимодействия с arataga через HTTP-вход описаны в curl_examples.md.

Задать вопрос или сообщить о проблеме можно в разделе Issues.

# Лицензия

Исходные тексты arataga распространяются под лицензией [GNU Affero GPL v3](https://www.gnu.org/licenses/agpl-3.0.txt).

